# NixOS Multi-Machine Configuration

Personal NixOS configuration managed with flakes, supporting multiple machines (x86_64 and aarch64) with Home Manager integration.

## Project Architecture

### Machine Configuration System
- Machines are defined in `machines.toml` with profile, platform, and feature flags
- `flake.nix` dynamically generates NixOS configurations from `machines.toml`
- Each machine has hardware config in `hardware/<machine-name>/hardware-configuration.nix`
- Special args passed to all modules: `isWorkstation`, `isLaptop`, `isVm`, `owner`, `bluetooth`, `lockScreen`, `autoLogin`

### Directory Structure
- `system/` - NixOS system-wide modules (boot, networking, desktop, packages, etc.)
- `home/` - Home Manager user configurations
  - `home/cli/` - CLI tools, shells, development tooling
  - `home/desktop/` - Wayland desktops (Hyprland, Niri), waybar, apps
  - `home/services/` - User services (mako, fcitx5, etc.)
  - `home/scripts/` - Custom user scripts
- `hardware/` - Per-machine hardware configurations
- `secrets/` - Encrypted secrets via sops-nix
- `keys/` - age public keys for sops recipients
- `certs/` - Enterprise SSL certificates
- `scripts/` - System-level scripts
- `assets/` - Icons and static assets

### Module Import Pattern
All `default.nix` files use explicit imports list. When adding functionality:
1. Create focused module file (e.g., `btop.nix`, `tmux.nix`)
2. Add to parent `default.nix` imports
3. Keep modules single-purpose and self-contained

## Build and Test Commands

### Standard Workflow
```bash
# Check flake validity and build all configurations
nix flake check

# Build specific machine without switching
nix build .#nixosConfigurations.workstation.config.system.build.toplevel

# Switch current system to configuration
sudo nixos-rebuild switch --flake .#workstation
sudo nixos-rebuild switch --flake .#hp-laptop
sudo nixos-rebuild switch --flake .#parallels-vm

# Test configuration without activation
sudo nixos-rebuild dry-run --flake .#workstation

# Update flake inputs (nixpkgs, home-manager, etc.)
nix flake update
```

### Development Testing
- ALWAYS run `nix flake check` before committing
- Use `sudo nixos-rebuild dry-run` to validate changes before switch
- Check `journalctl -xe` if services fail after rebuild

## Code Style and Conventions

### Nix Formatting
- 2-space indentation
- Use `with pkgs;` only in package lists, prefer explicit `pkgs.` elsewhere
- Keep attribute sets aligned and readable
- Multi-line imports with one module per line

### Naming Patterns
- Module files: lowercase with hyphens (e.g., `display-manager.nix`, `ssh-add-keys.nix`)
- Machine names: lowercase with hyphens matching `machines.toml`
- Variables: camelCase for functions, lowercase for simple values
- Special args: use descriptive names (`isWorkstation`, `owner`, not `ws`, `u`)

### Module Organization
- System modules: group by concern (networking, boot, desktop, etc.)
- Home modules: separate by domain (cli tools, desktop apps, services)
- Each module should be independently understandable
- Avoid circular dependencies between modules

## Git Workflow

### Commit Message Style
Use descriptive imperative messages:
- "Add <feature>" - for new functionality
- "Update <component>" - for enhancements to existing features
- "Fix <issue>" - for bug fixes
- "Remove <component>" - for deletions
- Examples: "Add databricks-cli to cloud packages", "Update niri keybinds for fullscreen and maximize"

### Before Committing
1. Run `nix flake check` to validate syntax
2. Test rebuild on at least one machine: `sudo nixos-rebuild dry-run --flake .#<machine>`
3. Verify no unintended files in staging (check `secrets/`, `hardware/`, `.env*`)
4. Keep commits focused - one logical change per commit

### Branch Strategy
- Main branch: `main` (stable configurations)
- Work directly on main for personal configs (single-user repo)
- Use WIP commits sparingly; prefer complete logical changes

## Important Rules

### Secrets Management (sops-nix)
- NEVER commit unencrypted secrets to git
- Edit secrets with: `sops secrets/secrets.yaml`
- Age keys in `keys/*.age.pub` must match machine hostnames
- Reference: `SOPS-SETUP-GUIDE.md` for setup procedures
- Secrets are automatically decrypted at boot via sops.nix module

### Flake Updates
- ONLY update `flake.lock` via `nix flake update`, never manually edit
- Pin nixpkgs to specific releases: `nixos-25.11` for stability
- Use `nixpkgs-unstable` input for bleeding-edge packages only when needed
- Test thoroughly after updates - inputs affect all machines

### Hardware Configurations
- NEVER manually edit `hardware/<machine>/hardware-configuration.nix` unless necessary
- Regenerate with: `nixos-generate-config --show-hardware-config`
- Keep machine-specific options (GPU drivers, boot loader) in hardware configs
- Use special args (bluetooth, wirelessInterface) for conditional features

### Home Manager Integration
- Home Manager is integrated as NixOS module, not standalone
- Single rebuild applies both system and user configs
- Backup extension format: `hm-backup-YYYYMMDD-HHMMSS`
- Don't fight Home Manager - let it manage dotfiles completely

### Desktop Environment (Wayland)
- Hyprland and Niri managed via UWSM (Universal Wayland Session Manager)
- Waybar uses Kanagawa theme - modify waybar configs, not base theme
- Session selection happens at login (greetd/tuigreet)
- Niri keybinds: Mod = Super key, wrapped movement across workspaces

### Package Management
- CLI tools go in `home/cli/default.nix`
- Development tools (LSPs, compilers) go in `home/cli/development.nix`
- Desktop apps go in `home/desktop/apps.nix`
- System packages go in `system/packages.nix`
- Use unstable packages sparingly: `inputs.nixpkgs-unstable.legacyPackages.${pkgs.system}.package-name`

### Certificate Handling
- Enterprise certificates in `certs/` directory
- Referenced in `system/default.nix` via `security.pki.certificateFiles`
- PEM format only - convert if needed

## Common Gotchas

### State Version
- `system.stateVersion` and `home.stateVersion` should RARELY change
- Only update when explicitly upgrading NixOS release
- Defined per-machine in `machines.toml`

### Profile-based Conditionals
- Use `isWorkstation`, `isLaptop`, `isVm` in modules for profile-specific config
- Use `lib.mkIf` for conditional module activation
- Example: `lib.mkIf bluetooth { hardware.bluetooth.enable = true; }`

### Parallel Build Issues
- If rebuilds hang, check for shared memory cleanup: `sudo ipcs` and `ipcrm -m <id>`
- Parallels VMs may need `boot.loader.timeout = 0` for fast boots

### XDG Directories
- Custom project directories in `home/default.nix` via activation scripts
- Some directories disabled (Desktop, Templates, Public) - intentional
- Project structure: `~/projects/work/` and `~/projects/personal/`

## Testing Checklist

After making changes, verify:
- [ ] `nix flake check` passes without errors
- [ ] `sudo nixos-rebuild dry-run --flake .#<machine>` succeeds
- [ ] No syntax errors or evaluation failures
- [ ] Services start correctly: `systemctl status <service>`
- [ ] User session loads properly after rebuild
- [ ] Desktop environment launches (if desktop changes)
- [ ] Secrets decrypt properly (if sops changes)

## Reference Documentation
- Main README: `README.md`
- Secrets setup: `SOPS-SETUP-GUIDE.md`
- NixOS manual: https://nixos.org/manual/nixos/stable/
- Home Manager manual: https://nix-community.github.io/home-manager/
- Niri docs: https://github.com/YaLTeR/niri
